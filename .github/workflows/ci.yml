name: Build and Release distributions

on:
  push:
    tags:
      - "v*" # Запускается при создании тега вида v1.0.0
  workflow_dispatch: # Позволяет запускать вручную

jobs:
  build-minified-jar:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: "25"
          distribution: "liberica"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

      - name: Build with Gradle
        run: ./gradlew proguardMinify

      - name: Upload minified JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jvm-ram-cost-minified-jar
          path: dist-app-backend/build/minified/jvm-ram-cost.jar
          retention-days: 1

  build-ubuntu:
    needs: [build-minified-jar]
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
      - name: Download minified JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jvm-ram-cost-minified-jar
          path: ./dist-app-backend/build/minified/     

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Yarn install
        run: yarn install

      - name: Generate protobuf files for TypeScript (Linux)
        run: |
          yarn proto:gen
      
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Embed app version into tauri.conf.json
        run: |
          echo '{"version": "${{ steps.version.outputs.version }}"}' > /tmp/tauri-versioned.conf.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            build-essential \
            curl \
            wget \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libglib2.0-dev

      - name: Build Tauri application
        run: |
          yarn tauri build --no-bundle

      - name: Package Tauri application into DEB
        run: |
          yarn tauri bundle --bundles deb -c /tmp/tauri-versioned.conf.json

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jvm-ram-cost-tauri-deb
          path: src-tauri/target/release/bundle/deb/jvm-ram-cost_*.deb
          retention-days: 1

  build-windows:
    needs: [build-minified-jar]
    runs-on: windows-2022
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
      - name: Download minified JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jvm-ram-cost-minified-jar
          path: ./dist-app-backend/build/minified/
     
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Yarn install
        run: yarn install

      - name: Generate protobuf files for TypeScript (Windows)
        run: |
          yarn proto:gen
      
      - name: Get version from tag
        id: version
        run: |
          $VERSION = $env:GITHUB_REF -replace 'refs/tags/v', ''
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          $TAG_NAME = $env:GITHUB_REF -replace 'refs/tags/', ''
          echo "tag_name=$TAG_NAME" >> $env:GITHUB_OUTPUT

      - name: Embed app version into tauri.conf.json
        run: |
          $json = @{version = "${{ steps.version.outputs.version }}" } | ConvertTo-Json -Compress
          $json | Out-File -FilePath "$env:TEMP\tauri-versioned.conf.json" -Encoding utf8

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Tauri application
        run: |
          yarn tauri build --no-bundle

      - name: Package Tauri application into MSI
        run: |
          yarn tauri bundle --bundles msi -c $env:TEMP\tauri-versioned.conf.json

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jvm-ram-cost-tauri-msi
          path: src-tauri/target/release/bundle/msi/jvm-ram-cost_*.msi
          retention-days: 1

  release:
    name: Create Release
    needs: [build-ubuntu, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Delete existing release if present
        run: |
          echo "Checking for existing release: ${{ steps.version.outputs.tag_name }}"
          if gh release view "${{ steps.version.outputs.tag_name }}" 2>/dev/null; then
            echo "Release exists, deleting..."
            gh release delete "${{ steps.version.outputs.tag_name }}" --yes
            echo "Release deleted successfully"
          else
            echo "Release does not exist, will create new one"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download Tauri DEB artifact
        uses: actions/download-artifact@v4
        with:
          name: jvm-ram-cost-tauri-deb
          path: ./distro/
      
      - name: Download Tauri MSI artifact
        uses: actions/download-artifact@v4
        with:
          name: jvm-ram-cost-tauri-msi
          path: ./distro/
            
      - name: Check files and prepare release
        id: check_files
        run: |
          echo "Available files in distro:"
          ls -la distro/
          FILES=""
          for file in distro/*.deb distro/*.msi; do
            if [ -f "$file" ]; then
              FILES="${FILES}${file}"$'\n'
            fi
          done
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Files to upload:"
          echo "$FILES"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## JVM RAM Cost ${{ steps.version.outputs.version }}  
            ### Установка  
            **Debian/Ubuntu:**
            Скачайте `.deb` файл из раздела Assets и установите:
            ```bash
            sudo dpkg -i jvm-ram-cost_*.deb
            ```  
            **Windows:**
            Скачайте `.msi` файл из раздела Assets и запустите установщик.
          files: ${{ steps.check_files.outputs.files }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
